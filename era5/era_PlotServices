import matplotlib.pyplot as plt
import xarray as xr
from matplotlib import animation
import numpy as np
import cartopy.crs as ccrs
import cartopy.feature as cfeature
import os
import subprocess
import pandas as pd

class PlotERA5():
    def __init__(self, output_dir, input_ds, var, colorbar):
        self.output_dir = output_dir
        self.varname = var
        self.ds = input_ds[var]
        self.colorbar = colorbar
        self.valid_time = input_ds[var]['valid_time']
        os.makedirs(output_dir, exist_ok=True)
    
    def MakePlot(self):
        for i in range(len(self.valid_time)):
            plt.figure(figsize=(6, 4))
            ax = plt.axes(projection=ccrs.SouthPolarStereo())
            ax.set_extent([-180, 180, -90, -60], ccrs.PlateCarree())
            ax.coastlines()
            ax.add_feature(cfeature.BORDERS, linewidth=0.3)
            ax.gridlines(draw_labels=True, dms=True, x_inline=False, y_inline=False)

            z = self.ds.isel(valid_time =i)
            z.plot(ax=ax, transform=ccrs.PlateCarree(), cmap=self.colorbar)
            dt = pd.to_datetime(self.valid_time.values[i])
            short_dt_str = dt.strftime('%m:%d:%H')
            plt.title(f"{self.varname} at {short_dt_str}")
            output_path = os.path.join(self.output_dir, f"frame_{i:03d}.png")
            plt.savefig(output_path)
            plt.close()
    
    def run(self):
        self.MakePlot()
        print(f'Output Directory: {self.output_dir}')
